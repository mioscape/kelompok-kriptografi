<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous" />
    <title>Traditional Cipher</title>
</head>

<body>
    <div class="container">
        <div class="card mt-4">
            <div class="card-header">Traditional Cipher</div>
            <div class="card-body">
                <form>
                    <div class="form-group"><label for="algoritme">Pilih jenis cipher</label><select class="form-control" id="algoritme"><option>Simple Vigenere Cipher</option><option>Extended Vigenere Cipher</option><option>Full Vigenere Cipher</option><option>Auto-key Vigenere Cipher</option><option>Super Cipher</option><option>Playfair Cipher</option><option>Hill Cipher</option><option>Affine Cipher</option><option>Enigma Cipher</option></select></div>
                    <div
                        class="file-method-group mb-3">
                        <div class="form-check form-check-inline"><input class="form-check-input" id="value-radio" type="radio" name="radio-file" value="value" checked="" /><label class="form-check-label" for="value-radio">File's value</label></div>
                        <div class="form-check form-check-inline"><input class="form-check-input" id="byte-radio" type="radio" name="radio-file" value="byte" /><label class="form-check-label" for="byte-radio">File's byte</label></div>
            </div>
            <div class="form-check form-check-inline"><input class="form-check-input" id="encrypt-radio" type="radio" name="radio" value="encrypt" checked="" /><label class="form-check-label" for="encrypt-radio">Encrypt</label></div>
            <div class="form-check form-check-inline"><input class="form-check-input" id="decrypt-radio" type="radio" name="radio" value="decrypt" /><label class="form-check-label" for="decrypt-radio">Decrypt </label></div>
            <div class="form-group mt-3"><label>Pilih file (optional)</label>
                <div class="input-group mb-3">
                    <div class="custom-file"><input class="custom-file-input" id="inputPlaintextFile" type="file" /><label class="custom-file-label" id="input-file-label" for="inputFile">Choose file</label></div>
                </div>
            </div>
            <div class="form-group mt-3" id="plaintext-group"><label for="plaintext">Plaintext</label><textarea class="form-control" id="plaintext" rows="2"></textarea></div>
            <div class="form-group mt-3" id="ciphertext-group"><label for="ciphertext">Ciphertext</label><textarea class="form-control" id="ciphertext" rows="2"></textarea></div>
            <div class="alert alert-danger fade show" role="alert"><strong>Key is not valid</strong></div>
            <div class="form-group" id="key-primary"><label for="key">Key</label><textarea class="form-control" id="key" rows="1"></textarea></div>
            <div class="form-group" id="key-form-affine-1"><label for="key-affine-1">Key 1</label><textarea class="form-control" id="affine-key-1" rows="1"></textarea></div>
            <div class="form-group" id="key-form-affine-2"><label for="key-affine-2">Key 2</label><textarea class="form-control" id="affine-key-2" rows="1"></textarea></div>
            <div class="spasi-cipher-group mb-3">
                <div class="form-check form-check-inline"><input class="form-check-input" id="no-spasi-radio" type="radio" name="radio-cipher" value="no-spasi" checked="" /><label class="form-check-label" for="no-spasi-radio">Tanpa spasi</label></div>
                <div class="form-check form-check-inline"><input class="form-check-input" id="with-spasi-radio" type="radio" name="radio-cipher" value="with-spasi" /><label class="form-check-label" for="with-spasi-radio">Kelompok 5 huruf</label></div>
            </div><button class="btn btn-success" id="btn-process">Process</button>
            <div class="form-group mt-3" id="result-group"><label id="label-result" for="result-text"></label><textarea class="form-control" id="result-text" rows="2"></textarea><button class="btn btn-success mt-3" id="btn-download">Download</button></div>
            </form>
        </div>
    </div>
    </div>
    <script type="text/javascript">
        var plaintextGroup = document.querySelector("#plaintext-group");
        var ciphertextGroup = document.querySelector("#ciphertext-group");
        var plaintext = document.querySelector("#plaintext");
        var ciphertext = document.querySelector("#ciphertext");
        var key = document.querySelector("#key");
        var resultGroup = document.querySelector("#result-group");
        var labelResult = document.querySelector("#label-result");
        var keyPrimary = document.querySelector("#key-primary");
        var affineKey1Group = document.querySelector("#key-form-affine-1");
        var affineKey2Group = document.querySelector("#key-form-affine-2");
        var affineKey1 = document.querySelector("#key-form-affine-1 #affine-key-1");
        var affineKey2 = document.querySelector("#key-form-affine-2 #affine-key-2");
        var textResult = document.querySelector("#result-group #result-text");
        var alert = document.querySelector(".alert");
        var inputFileLabel = document.querySelector("#input-file-label");
        var fileMethodGroup = document.querySelector(".file-method-group");
        var spasiCipherGroup = document.querySelector(".spasi-cipher-group");

        var buttonProcess = document.querySelector("#btn-process")
        var buttonDownload = document.querySelector("#btn-download")

        var isEncrypt = true;
        var fileValue = true;
        var withSpasi = false;

        var file;
        var dataExtended;

        resultGroup.style.display = "none";
        alert.style.display = "none";
        ciphertextGroup.style.display = "none";
        fileMethodGroup.style.display = "none";
        affineKey1Group.style.display = "none";
        affineKey2Group.style.display = "none";

        document.querySelector("#encrypt-radio").addEventListener("change", function() {
            isEncrypt = true;
            ciphertextGroup.style.display = "none";

            if (!fileValue) {
                plaintextGroup.style.display = "none";
                spasiCipherGroup.style.display = "none";
            } else {
                plaintextGroup.style.display = "block";
                spasiCipherGroup.style.display = "block";
            }

            plaintext.value = "";
            ciphertext.value = "";
            inputFileLabel.innerHTML = "Choose file";
        });

        document.querySelector("#decrypt-radio").addEventListener("change", function() {
            isEncrypt = false;
            plaintextGroup.style.display = "none";
            spasiCipherGroup.style.display = "none";

            if (!fileValue) {
                ciphertextGroup.style.display = "none";
            } else {
                ciphertextGroup.style.display = "block";
            }

            plaintext.value = "";
            ciphertext.value = "";
            inputFileLabel.innerHTML = "Choose file";
        });

        document.querySelector("#with-spasi-radio").addEventListener("change", function() {
            withSpasi = true;
        });

        document.querySelector("#no-spasi-radio").addEventListener("change", function() {
            withSpasi = false;
        });

        document.querySelector("#value-radio").addEventListener("change", function() {
            fileValue = true;

            if (!isEncrypt) {
                plaintextGroup.style.display = "none";
                ciphertextGroup.style.display = "block";
                spasiCipherGroup.style.display = "block";
            } else {
                plaintextGroup.style.display = "block";
                ciphertextGroup.style.display = "none";
                spasiCipherGroup.style.display = "none";
            }
        });

        document.querySelector("#byte-radio").addEventListener("change", function() {
            fileValue = false;
            plaintextGroup.style.display = "none";
            ciphertextGroup.style.display = "none";
            spasiCipherGroup.style.display = "none";
        });

        function getSelectedOptions(select) {
            var options = select.getElementsByTagName('option');
            for (var i = 0; i < options.length; i++) {
                if (options[i].selected)
                    return options[i];
            };
        }

        var algoritme = {
            "Simple Vigenere Cipher": "vigenere",
            "Extended Vigenere Cipher": "extended",
            "Variant Vigenere Cipher": "variant",
            "Full Vigenere Cipher": "full",
            "Auto-key Vigenere Cipher": "autokey",
            "Super Cipher": "super",
            "Playfair Cipher": "playfair",
            "Hill Cipher": "hill",
            "Affine Cipher": "affine",
            "Enigma Cipher": "enigma"
        }

        var select = document.querySelector('#algoritme');
        var selectedOption = getSelectedOptions(select).text;

        document.querySelector("select").addEventListener("change", function() {
            selectedOption = getSelectedOptions(select).text;
            if (algoritme[selectedOption] === "extended") {
                fileMethodGroup.style.display = "block";
                affineKey1Group.style.display = "none";
                affineKey2Group.style.display = "none";
            } else if (algoritme[selectedOption] === "affine") {
                fileMethodGroup.style.display = "none";
                affineKey1Group.style.display = "block";
                affineKey2Group.style.display = "block";
                keyPrimary.style.display = "none";
                affineKey1.value = "";
                affineKey2.value = "";
            } else {
                fileMethodGroup.style.display = "none";
                affineKey1Group.style.display = "none";
                affineKey2Group.style.display = "none";
                keyPrimary.style.display = "block";
            }
        });

        function alphabetOnly(text) {
            return text.replace(/[^a-zA-Z]+/g, '')
        }

        function numberOnly(text) {
            return text.replace(/[^0-9]+/g, '');
        }

        function groupingText(text) {
            var output = "";
            for (let i = 0; i < text.length; i++) {
                output += text[i];
                if (i % 5 == 4) output += " ";
            }

            return output;
        }

        function ab2str(buf) {
            return String.fromCharCode.apply(null, new Uint8Array(buf));
        }

        function str2ab(str) {
            var buf = new ArrayBuffer(str.length); // 2 bytes for each char
            var bufView = new Uint8Array(buf);

            for (var i = 0, strLen = str.length; i < strLen; i++) {
                bufView[i] = str.charCodeAt(i);
            }

            return buf;
        }

        document.querySelector('#inputPlaintextFile').addEventListener('input', function(evt) {
            var files = evt.target.files;
            file = files[0];
            inputFileLabel.innerHTML = file.name;

            var reader = new FileReader();

            if (fileValue) {
                reader.onload = function(event) {
                    if (isEncrypt) plaintext.value = alphabetOnly(event.target.result.toLowerCase());
                    else ciphertext.value = alphabetOnly(event.target.result.toUpperCase());
                }

                reader.readAsText(file)
            } else {
                var fileByteArray = [];
                var output = "";

                reader.readAsArrayBuffer(file);
                reader.onloadend = function(evt) {
                    if (evt.target.readyState == FileReader.DONE) {
                        var arrayBuffer = evt.target.result;
                        var array = new Uint8Array(arrayBuffer);

                        for (var i = 0; i < array.length; i++) {
                            fileByteArray.push(array[i]);
                            output += String.fromCharCode(array[i])
                        }

                        dataExtended = array;

                        if (isEncrypt) plaintext.value = output;
                        else ciphertext.value = output;
                    }
                }
            }
        }, false);

        plaintext.addEventListener("input", function() {
            var selectedAlgo = algoritme[selectedOption];
            if (selectedAlgo != "extended") {
                plaintext.value = alphabetOnly(plaintext.value.toLowerCase());
            }
        })

        ciphertext.addEventListener("input", function() {
            var selectedAlgo = algoritme[selectedOption];
            if (selectedAlgo != "extended") {
                ciphertext.value = alphabetOnly(ciphertext.value.toUpperCase());
            }
        })

        key.addEventListener("input", function() {
            key.value = alphabetOnly(key.value.toLowerCase());
        })

        document.querySelector("#affine-key-1").addEventListener("input", function() {
            affineKey1.value = numberOnly(affineKey1.value);
        });

        document.querySelector("#affine-key-2").addEventListener("input", function() {
            affineKey2.value = numberOnly(affineKey2.value);
        });

        buttonProcess.addEventListener("click", async function(event) {
            event.preventDefault();
            alert.style.display = "none";
            resultGroup.style.display = "none";

            var isValid = true;

            try {
                if (algoritme[selectedOption] == "hill") {
                    if (key.value.length != 9) {
                        isValid = false;
                        alert.style.display = "block";
                    } else {
                        var data = await fetch(`/check/hill/${key.value}`)
                        var result = await data.json();
                        if (!result.data) {
                            alert.style.display = "block";
                            isValid = false;
                        }
                    }
                } else if (algoritme[selectedOption] === "affine") {
                    var data = await fetch(`/check/affine/${affineKey1.value}`);
                    var result = await data.json();
                    if (!result.data) {
                        alert.style.display = "block";
                        isValid = false;
                    }
                } else if (algoritme[selectedOption] === "enigma") {
                    if (key.value.length != 3) {
                        isValid = false;
                        alert.style.display = "block";
                    }
                }
            } catch (err) {
                isValid = false;
            }

            if (isEncrypt && isValid) {
                var data = {
                    text: plaintext.value,
                }

                if (algoritme[selectedOption] === 'extended' && dataExtended !== undefined) {
                    data.text = dataExtended
                }

                if (algoritme[selectedOption] === 'affine') {
                    data = {
                        ...data,
                        key1: affineKey1.value,
                        key2: affineKey2.value
                    }
                } else {
                    data = {
                        ...data,
                        key: key.value
                    }
                }

                fetch(`/encrypt/${algoritme[selectedOption]}`, {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    })
                    .then(async function(response) {
                        var encryptedText = await response.json();

                        if (fileValue) {
                            resultGroup.style.display = "block";
                            labelResult.innerHTML = "Hasil encrypt"
                            textResult.value = !withSpasi ? encryptedText.data : groupingText(encryptedText.data);
                        } else {
                            downloadFile(file.name, [str2ab(encryptedText.data)], 'octet/stream')
                        }
                    })
                    .catch(function(err) {
                        console.error(err);
                    })
            } else if (!isEncrypt && isValid) {
                var data = {
                    text: ciphertext.value,
                }

                if (algoritme[selectedOption] === 'extended' && dataExtended !== undefined) {
                    data.text = dataExtended
                }

                if (algoritme[selectedOption] === 'affine') {
                    data = {
                        ...data,
                        key1: affineKey1.value,
                        key2: affineKey2.value
                    }
                } else {
                    data = {
                        ...data,
                        key: key.value
                    }
                }

                fetch(`/decrypt/${algoritme[selectedOption]}`, {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    })
                    .then(async function(response) {
                        var decryptedText = await response.json();

                        if (fileValue) {
                            resultGroup.style.display = "block";
                            labelResult.innerHTML = "Hasil decrypt"
                            textResult.value = decryptedText.data;
                        } else {
                            downloadFile(file.name, [str2ab(decryptedText.data)], 'octet/stream')
                        }
                    })
                    .catch(function(err) {
                        console.error(err);
                    })
            }
        });

        function downloadFile(filename, data, type) {
            var file = new Blob(data, {
                type
            });

            if (window.navigator.msSaveOrOpenBlob) // IE10+
                window.navigator.msSaveOrOpenBlob(file, filename);
            else { // Others
                var a = document.createElement("a")
                var url = URL.createObjectURL(file);

                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();

                setTimeout(function() {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 0);
            }
        }

        buttonDownload.addEventListener("click", function() {
            var filename = Date.now() + ".txt";
            var data = textResult.value;
            downloadFile(filename, [data], "text/plain");
        })
    </script>
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
</body>

</html>